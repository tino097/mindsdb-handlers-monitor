name: MindsDB MS SQL Server Monitor CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mssql/**'
      - '.github/workflows/mssql-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mssql/**'
      - '.github/workflows/mssql-tests.yml'
  workflow_dispatch:

env:
  MSSQL_SA_PASSWORD: 'YourStrong@Passw0rd'
  MSSQL_DB: 'TestDB'
  MSSQL_USER: 'testuser'
  MSSQL_USER_PASSWORD: 'TestUser@123'

jobs:
  test-mssql-handler:
    runs-on: ubuntu-latest
    
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: 'Y'
          MSSQL_SA_PASSWORD: 'YourStrong@Passw0rd'
          MSSQL_PID: 'Developer'
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1"
          --health-interval 10s
          --health-timeout 10s
          --health-retries 10
          --health-start-period 60s

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pymssql mindsdb

    - name: â³ Wait for SQL Server to be ready
      run: |
        echo "Waiting for SQL Server to be fully ready..."
        for i in {1..30}; do
          if docker exec $(docker ps -q -f ancestor=mcr.microsoft.com/mssql/server:2022-latest) /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q "SELECT 1" > /dev/null 2>&1; then
            echo "SQL Server is ready!"
            break
          fi
          echo "Attempt $i: SQL Server not ready yet, waiting..."
          sleep 2
        done

    - name: ðŸ—„ï¸ Initialize database and create test user
      run: |
        docker exec $(docker ps -q -f ancestor=mcr.microsoft.com/mssql/server:2022-latest) /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q "
        CREATE DATABASE TestDB;
        GO
        USE TestDB;
        GO
        CREATE LOGIN testuser WITH PASSWORD = 'TestUser@123';
        GO
        CREATE USER testuser FOR LOGIN testuser;
        GO
        ALTER ROLE db_owner ADD MEMBER testuser;
        GO
        "

    - name: ðŸ“Š Load test data into SQL Server
      run: |
        docker exec $(docker ps -q -f ancestor=mcr.microsoft.com/mssql/server:2022-latest) /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -d TestDB -i /github/workspace/mssql/sql/init_schema.sql
        docker exec $(docker ps -q -f ancestor=mcr.microsoft.com/mssql/server:2022-latest) /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -d TestDB -i /github/workspace/mssql/sql/load_data.sql

    - name: ðŸ§ª Run MS SQL handler tests
      env:
        MSSQL_HOST: localhost
        MSSQL_PORT: 1433
        MSSQL_USER: testuser
        MSSQL_PASSWORD: 'TestUser@123'
        MSSQL_DATABASE: TestDB
      run: |
        cd mssql
        pytest tests/ -v --tb=short --cov=. --cov-report=term-missing

    - name: ðŸ“Š Generate test report
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f mssql/.coverage ]; then
          echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Tests failed or did not complete" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¤ Upload coverage reports
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./mssql/coverage.xml
        flags: mssql
        name: mssql-handler-coverage
        fail_ci_if_error: false