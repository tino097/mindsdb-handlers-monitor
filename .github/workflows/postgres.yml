name: MindsDB PostgreSQL Monitor CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

  workflow_dispatch: {}

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install MindsDB if not in requirements.txt
          pip install mindsdb psycopg2-binary

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do 
            echo "Waiting for PostgreSQL..."
            sleep 1
          done
          echo "PostgreSQL is ready!"

      - name: Install & start MindsDB
        run: |
          python -m pip install --upgrade pip

          # Install MindsDB from your fork or main repo
          git clone https://github.com/mindsdb/mindsdb.git
          cd mindsdb
          pip install -e .[postgres]

          echo "ðŸš€ Starting MindsDB..."
          MINDSDB_NO_STUDIO=1 python -m mindsdb --api http --verbose > /tmp/mindsdb.log 2>&1 &
          echo "MINDSDB_PID=$!" >> $GITHUB_ENV

          echo "â³ Waiting for MindsDB to be ready..."
          for i in $(seq 1 180); do
            echo "[$i] Checking MindsDB..."
            if curl -sf http://127.0.0.1:47334/api/status >/dev/null; then
              echo "âœ… MindsDB is ready!"
              exit 0
            fi
            sleep 1
          done

          echo "âŒ MindsDB failed to start"
          echo "=== MindsDB logs ==="
          cat /tmp/mindsdb.log
          exit 1

      - name: Verify services
        run: |
          echo "ðŸ” Verifying all services are running..."

          # Check PostgreSQL
          pg_isready -h localhost -p 5432 -U postgres && echo "âœ… PostgreSQL: Running" || echo "âŒ PostgreSQL: Not Running"

          # Check MindsDB
          curl -sf http://127.0.0.1:47334/api/status | tee /tmp/mindsdb_status.json || echo "âŒ MindsDB: Not responding"

          echo ""
          echo "ðŸ“‹ MindsDB Status:"
          cat /tmp/mindsdb_status.json | python3 -m json.tool || true

      - name: Run tests with result tracking
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          MINDSDB_API_URL: http://localhost:47334
        run: |
          echo "ðŸ§ª Running PostgreSQL handler tests..."

          # Create results directory
          mkdir -p /tmp/test_results

          # Run tests with detailed output
          cd postgres/tests
          pytest -v --tb=short --junit-xml=/tmp/test_results/junit.xml --html=/tmp/test_results/report.html --self-contained-html || true

          echo "âœ… Tests completed"

      - name: Generate test summary
        if: always()
        run: |
          set -eu
          echo "=== Generating Test Summary ==="

          # Initialize counters
          total_tests=0
          passed=0
          failed=0
          errors=0
          skipped=0

          # Check if JUnit XML exists
          if [ -f /tmp/test_results/junit.xml ]; then
            # Parse JUnit XML for test counts
            if command -v python3 &> /dev/null; then
              python3 <<'PYEOF' > /tmp/test_summary.txt
          import xml.etree.ElementTree as ET
          import sys

          try:
              tree = ET.parse('/tmp/test_results/junit.xml')
              root = tree.getroot()
              
              # Get test suite stats
              testsuite = root.find('.//testsuite')
              if testsuite is not None:
                  tests = int(testsuite.get('tests', 0))
                  failures = int(testsuite.get('failures', 0))
                  errors = int(testsuite.get('errors', 0))
                  skipped = int(testsuite.get('skipped', 0))
                  passed = tests - failures - errors - skipped
                  
                  print(f"{tests},{passed},{failures},{errors},{skipped}")
              else:
                  print("0,0,0,0,0")
          except Exception as e:
              print(f"0,0,0,0,0", file=sys.stderr)
              print(f"Error: {e}", file=sys.stderr)
          PYEOF
              
              if [ -f /tmp/test_summary.txt ]; then
                IFS=',' read -r total_tests passed failed errors skipped < /tmp/test_summary.txt
              fi
            fi
          fi

          # Calculate success rate
          success_rate=0
          if [ $total_tests -gt 0 ]; then
            success_rate=$(( passed * 100 / total_tests ))
          fi

          # Generate markdown summary
          {
            echo "# MindsDB PostgreSQL Handler Test Results"
            echo ""
            echo "## Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Total Tests | $total_tests |"
            echo "| âœ… Passed | $passed |"
            echo "| âŒ Failed | $failed |"
            echo "| âš ï¸ Errors | $errors |"
            echo "| â­ï¸ Skipped | $skipped |"
            echo "| Success Rate | ${success_rate}% |"
            echo ""
            
            # Overall status
            if [ $total_tests -eq 0 ]; then
              echo "## âš ï¸ No Tests Found"
              echo ""
              echo "No test results were generated. Please check your test configuration."
              
            elif [ $passed -eq $total_tests ]; then
              echo "## ðŸŽ‰ All Tests Passed!"
              echo ""
              echo "The MindsDB PostgreSQL handler is working correctly with all tests."
              
            elif [ $passed -gt 0 ]; then
              echo "## âš ï¸ Partial Success"
              echo ""
              echo "Some tests passed but issues were detected. Please review failed tests."
              
            else
              echo "## âŒ All Tests Failed"
              echo ""
              echo "The PostgreSQL handler has critical issues. Please review the test logs."
            fi
            
            echo ""
            echo "## Database Configuration"
            echo ""
            echo "| Parameter | Value |"
            echo "|-----------|-------|"
            echo "| Host | localhost |"
            echo "| Port | 5432 |"
            echo "| Database | test_db |"
            echo "| Schema | test_schema |"
            echo "| PostgreSQL Version | 15 |"
            echo ""
            
            echo "## Test Data"
            echo ""
            echo "| Table | Rows |"
            echo "|-------|------|"
            echo "| customers | 5 |"
            echo "| products | 5 |"
            echo "| orders | 5 |"
            echo "| order_items | 7 |"
            echo ""
            
            # Add test execution details if available
            if [ -f /tmp/test_results/junit.xml ]; then
              echo "## Test Details"
              echo ""
              python3 <<'PYEOF'
          import xml.etree.ElementTree as ET

          try:
              tree = ET.parse('/tmp/test_results/junit.xml')
              root = tree.getroot()
              
              print("| Test Name | Status | Duration |")
              print("|-----------|--------|----------|")
              
              for testcase in root.findall('.//testcase'):
                  name = testcase.get('name', 'Unknown')
                  time = float(testcase.get('time', 0))
                  
                  # Check status
                  if testcase.find('failure') is not None:
                      status = "âŒ Failed"
                  elif testcase.find('error') is not None:
                      status = "âš ï¸ Error"
                  elif testcase.find('skipped') is not None:
                      status = "â­ï¸ Skipped"
                  else:
                      status = "âœ… Passed"
                  
                  print(f"| {name} | {status} | {time:.3f}s |")
          except Exception as e:
              print(f"Could not parse test details: {e}")
          PYEOF
              echo ""
            fi
            
            echo "---"
            echo ""
            echo "**Analysis completed:** $(date '+%A, %B %d, %Y at %I:%M %p %Z')"
            
          } > /tmp/combined_summary.md

          # Output to GitHub Actions summary
          cat /tmp/combined_summary.md >> $GITHUB_STEP_SUMMARY

          echo "âœ… Test summary generated"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mindsdb-postgres-test-results
          path: |
            /tmp/test_results/
            /tmp/mindsdb.log
            /tmp/combined_summary.md
          retention-days: 7

      - name: Upload MindsDB logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: mindsdb-logs
          path: /tmp/mindsdb.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          if [ -n "${MINDSDB_PID:-}" ]; then
            kill ${MINDSDB_PID} || true
            echo "âœ… MindsDB stopped"
          fi

          # Show final PostgreSQL stats
          echo ""
          echo "ðŸ“Š Final PostgreSQL Connection Stats:"
          PGPASSWORD=postgres psql -h localhost -U postgres -d test_db -c "SELECT datname, numbackends, xact_commit, xact_rollback FROM pg_stat_database WHERE datname = 'test_db';" || true
